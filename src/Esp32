// Importando bibliotecas
#include <ArduinoJson.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <HX711.h>
#include "DHT.h"

// Definindo vari√°veis
const int pinoDHT = 2;
const int pinoLuz = 33;
const int PINO_DT1 = 27;
const int PINO_SCK1 = 26;
const int PINO_DT2 = 21;
const int PINO_SCK2 = 13;
const int LED_PIN = 19;
const int AR_PIN = 18;
const int LED_VERDE_PIN = 23;
const int LED_AMARELO_PIN = 22;
const int TEMPO_ESPERA = 3000;
float fator_calibracao1 = -83000;
float fator_calibracao2 = -100000000;
#define tipoDHT DHT11

// Instanciando objetos
HX711 escala1;
HX711 escala2;
DHT dht(pinoDHT, tipoDHT);

// Configura√ß√µes de rede do Esp32
const char* ssid = "FAMILIA DOURADO";
const char* password = "Dour@do01072004";
const char* tagoToken = "53b9c773-1b1d-4c33-9805-ea36485ee8cb";

void setup() {
  pinMode(LED_PIN, OUTPUT);
  pinMode(LED_VERDE_PIN, OUTPUT);
  pinMode(LED_AMARELO_PIN, OUTPUT);
  dht.begin();

  Serial.begin(115200);
  delay(2000);

  WiFi.begin(ssid, password);
  Serial.print("Conectando ao Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWi-Fi conectado!");
  Serial.print("IP: "); Serial.println(WiFi.localIP());

  escala1.begin(PINO_DT1, PINO_SCK1);
  if (!escala1.is_ready()) {
    Serial.println("Balan√ßa loja n√£o disponivel! Verifique as conex√µes.");
  }

  escala2.begin(PINO_DT2, PINO_SCK2);
  if (!escala1.is_ready()) {
    Serial.println("Balan√ßa estoque n√£o disponivel! Verifique as conex√µes.");
  }

  float media_leitura1 = escala1.read_average();
  Serial.print("M√©dia de leituras loja sem carga: ");
  Serial.println(media_leitura1, 2);

  float media_leitura2 = escala2.read_average();
  Serial.print("M√©dia de leituras estoque sem carga: ");
  Serial.println(media_leitura2, 2);

  escala1.tare();
  Serial.println("Balan√ßa loja zerada.");

  escala2.tare();
  Serial.println("Balan√ßa estoque zerada.");
}

void loop() {
  escala1.set_scale(fator_calibracao1);
  escala2.set_scale(fator_calibracao2);

  if (escala1.is_ready()) {
    float pesoloja = escala1.get_units();
    Serial.print("Leitura loja: ");
    Serial.print(pesoloja, 2);
    Serial.println(" kg");

    buscarDados();
    enviarHTTP("pesoloja", pesoloja, "kg");
  } else {
    Serial.println("Balan√ßa loja ocupado ou desconectado!");
  }

  if (escala2.is_ready()) {
    float pesoestoque = escala2.get_units();
    Serial.print("Leitura estoque: ");
    Serial.print(pesoestoque, 2);
    Serial.println(" kg");

    buscarDados();
    enviarHTTP("pesoestoque", pesoestoque, "kg");
  } else {
    Serial.println("Balan√ßa estoque ocupado ou desconectado!");
  }

  float temperatura = capturarTemperatura();
  float luminosidade = capturarLuminosidade();
  enviarHTTP("temperaturaLoja", temperatura, "¬∞C");
  enviarHTTP("luminosidadeLoja", luminosidade, " ");

  delay(TEMPO_ESPERA);
}

float capturarTemperatura(){
  float temperatura = dht.readTemperature();

  if(isnan(temperatura)){
    Serial.println("Erro ao ler temperatura");
    return 0.0;
  }

  Serial.print("Temperatura: ");
  Serial.print(temperatura);
  Serial.println(" ¬∞C");

  return temperatura;
}


float capturarLuminosidade() {
  int leitura = analogRead(pinoLuz);

  if (leitura < 0) {
    Serial.println("Erro: leitura inv√°lida do sensor de luz.");
    return 0.0;
  }

  float luminosidade = (leitura / 4095.0) * 100.0;

  Serial.print("Luminosidade: ");
  Serial.print(luminosidade, 2);
  Serial.println(" %");

  return luminosidade;
}

void enviarHTTP(char* nome, float var, char* unidade) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ö†Ô∏è Wi-Fi n√£o conectado!");
    return;
  }

  HTTPClient http;
  http.begin("https://api.tago.io/data");
  http.addHeader("Content-Type", "application/json");
  http.addHeader("Device-Token", tagoToken);

  DynamicJsonDocument doc(200);
  JsonArray arr = doc.to<JsonArray>();
  JsonObject obj = arr.createNestedObject();
  obj["variable"] = nome;
  obj["value"] = var;
  obj["unit"] = unidade;

  String payload;
  serializeJson(doc, payload);

  int httpResponseCode = http.POST(payload);

  if (httpResponseCode > 0) {
    Serial.print("üì§ Dados enviados! C√≥digo HTTP: ");
    Serial.println(httpResponseCode);
  } else {
    Serial.print("‚ö†Ô∏è Erro ao enviar dados: ");
    Serial.println(http.errorToString(httpResponseCode));
  }
  http.end();
}

void enviarHTTP(char* nome, char* var, char* unidade) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ö†Ô∏è Wi-Fi n√£o conectado!");
    return;
  }

  HTTPClient http;
  http.begin("https://api.tago.io/data");
  http.addHeader("Content-Type", "application/json");
  http.addHeader("Device-Token", tagoToken);

  DynamicJsonDocument doc(200);
  JsonArray arr = doc.to<JsonArray>();
  JsonObject obj = arr.createNestedObject();
  obj["variable"] = nome;
  obj["value"] = var;
  obj["unit"] = unidade;

  String payload;
  serializeJson(doc, payload);

  int httpResponseCode = http.POST(payload);

  if (httpResponseCode > 0) {
    Serial.print("üì§ Dados enviados! C√≥digo HTTP: ");
    Serial.println(httpResponseCode);
  } else {
    Serial.print("‚ö†Ô∏è Erro ao enviar dados: ");
    Serial.println(http.errorToString(httpResponseCode));
  }

  http.end();
}

void buscarDados(){
   HTTPClient http;
    http.begin("https://khprnw-3001.csb.app/buscarDadosTago");  // Inicia conex√£o

    int httpCode = http.GET(); // Faz requisi√ß√£o GET

    if (httpCode > 0) {
      String payload = http.getString();
      Serial.println("Resposta:");
      Serial.println(payload);

      // Parse do JSON
      StaticJsonDocument<200> doc;
      DeserializationError error = deserializeJson(doc, payload);

      if (!error) {
        float pesoloja = doc["pesoloja"];
        float luminosidadeloja = doc["luminosidadeloja"];
        int temperatura = doc["temperatura"];
        const char* ledloja = doc["ledloja"];
        const char* arcondicionadoloja = doc["arcondicionadoloja"];
        const char* automacoes = doc["automacoes"];
        const char* cor = doc["cor"];

        Serial.printf("Pesoloja: %.3f\n", pesoloja);
        Serial.printf("Temperatura: %d\n", temperatura);
        Serial.printf("LedLoja: %s\n", ledloja);
        Serial.printf("Cor Led Prateleira: %s\n", cor);

        if (strcmp(automacoes, "activate") == 0) {
            if (luminosidadeloja > 70.00) {
              digitalWrite(LED_PIN, HIGH);
              enviarHTTP("ledloja", "activate", "");
              Serial.println("LED LOJA ATIVADO");
            } else {
              digitalWrite(LED_PIN, LOW);
              enviarHTTP("ledloja", "deactivate", "");
              Serial.println("LED LOJA DESATIVADO");
            }

            if (temperatura > 21.00) {
              digitalWrite(AR_PIN, HIGH);
              enviarHTTP("arcondicionadoloja", "activate", "");
              Serial.println("AR CONDICIONADO LOJA ATIVADO");
            } else {
              digitalWrite(AR_PIN, LOW);
              enviarHTTP("arcondicionadoloja", "deactivate", "");
              Serial.println("AR CONDICIONADO LOJA DESATIVADO");
            }
        }else if (strcmp(automacoes, "deactivate") == 0){
          if (strcmp(ledloja, "activate") == 0) {
            digitalWrite(LED_PIN, HIGH);
            Serial.println("LED ATIVADO");
          } else {
            digitalWrite(LED_PIN, LOW);
            Serial.println("LED DESLIGADO");
          }

          if (strcmp(arcondicionadoloja, "activate") == 0) {
            digitalWrite(AR_PIN, HIGH);
            Serial.println("AR CONDICIONADO LOJA ATIVADO");
          } else {
            digitalWrite(AR_PIN, LOW);
            Serial.println("AR CONDICIONADO LOJA DESATIVADO");
          }
        }

        if (strcmp(cor, "verde") == 0) {
            digitalWrite(LED_VERDE_PIN, HIGH);
            digitalWrite(LED_AMARELO_PIN, LOW);
            Serial.println("LED VERDE ATIVADO");
        }else if (strcmp(cor, "amarelo") == 0){
            digitalWrite(LED_VERDE_PIN, LOW);
            digitalWrite(LED_AMARELO_PIN, HIGH);
            Serial.println("LED AMARELO ATIVADO");
        }

        
      } else {
        Serial.println("Erro ao parsear JSON");
      }

    } else {
      Serial.printf("Erro na requisi√ß√£o HTTP: %d\n", httpCode);
    }

    http.end(); // Libera recursos
}
